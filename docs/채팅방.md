# 채팅방 관리 시스템

## 개요
Jiny Chat 패키지의 채팅방 관리 시스템은 사용자가 채팅방을 생성, 수정, 삭제할 수 있는 기능을 제공합니다. 각 채팅방은 독립된 SQLite 데이터베이스로 운영되어 확장성과 성능을 보장합니다.

## 주요 기능

### 1. 채팅방 대시보드 (`/home/chat`)
사용자가 참여하고 있는 채팅방의 목록을 표시합니다.

#### 기능
- 참여 중인 채팅방 목록 조회
- 각 채팅방별 읽지 않은 메시지 수 표시
- 채팅방 유형별 배지 표시 (공개방/비공개방)
- 방장 권한 표시
- 페이지네이션 지원

#### 컨트롤러 
- `ChatIndexController`: 채팅방 목록 조회 및 표시
- 위치: `vendor/jiny/chat/src/Http/Controllers/Home/Dashboard/ChatIndexController.php`

#### 뷰 파일
- `index.blade.php`: 채팅방 목록 화면
- 위치: `vendor/jiny/chat/resources/views/home/dashboard/index.blade.php`

### 2. 채팅방 생성
새로운 채팅방을 개설하고 자동으로 생성자를 방장으로 등록합니다.

#### 생성 프로세스
1. **기본 정보 입력**
   - 채팅방 제목 (필수)
   - 슬러그 (URL 주소, 자동 생성 가능)
   - 설명 (선택사항)
   - 대표 이미지 업로드

2. **채팅방 타입 설정**
   - **공개 채팅방**: 누구나 검색하고 참여 가능
   - **비공개 채팅방**: 초대를 통해서만 참여 가능
   - **그룹 채팅방**: 소규모 그룹용

3. **접근 및 권한 설정**
   - 검색 가능 여부
   - 자유 참여 허용
   - 초대 허용
   - 비밀번호 설정 (선택사항)

4. **기능 설정**
   - 최대 참여자 수 제한 (0: 무제한, 2-1000명)

#### 기술적 구현
- **JWT 인증**: 사용자 인증은 JWT 토큰 기반
- **사용자 샤딩**: `user_0xx` 형태로 사용자 데이터 샤딩
- **파사드 활용**: `JwtAuth::`, `Shard::` 파사드 사용
- **SQLite 파일 생성**: `database/chat/년/월/일/room-{id}.sqlite` 형태

#### 컨트롤러
- `ChatCreateController`: 채팅방 생성 로직 처리
- 위치: `vendor/jiny/chat/src/Http/Controllers/Home/Dashboard/ChatCreateController.php`

#### 뷰 파일
- `create.blade.php`: 채팅방 생성 폼 화면
- 위치: `vendor/jiny/chat/resources/views/home/dashboard/create.blade.php`

### 3. 채팅방 수정
방장이 채팅방 설정을 수정할 수 있습니다.

#### 수정 가능 항목
- 기본 정보 (제목, 슬러그, 설명)
- 대표 이미지 교체
- 채팅방 타입 변경
- 접근 권한 설정
- 비밀번호 변경
- 최대 참여자 수 조정

#### 권한 확인
- 방장(`owner_uuid`) 권한 필수
- 권한이 없는 경우 접근 차단

#### 컨트롤러
- `ChatEditController`: 채팅방 수정 로직 처리
- 위치: `vendor/jiny/chat/src/Http/Controllers/Home/Dashboard/ChatEditController.php`

#### 뷰 파일
- `edit.blade.php`: 채팅방 수정 폼 화면
- 위치: `vendor/jiny/chat/resources/views/home/dashboard/edit.blade.php`

### 4. 채팅방 삭제
방장이 채팅방을 완전히 삭제할 수 있습니다.

#### 삭제 프로세스
1. **권한 확인**: 방장 권한 검증
2. **참여자 삭제**: 모든 참여자 레코드 제거
3. **SQLite 삭제**: 채팅방 전용 데이터베이스 파일 삭제
4. **첨부파일 삭제**: 관련된 모든 첨부파일 제거
5. **메인 레코드 삭제**: 채팅방 메인 테이블에서 삭제

#### 안전 장치
- 트랜잭션 처리로 데이터 일관성 보장
- 상세한 로그 기록
- 빈 디렉토리 자동 정리

#### 컨트롤러
- `ChatDeleteController`: 채팅방 삭제 로직 처리
- 위치: `vendor/jiny/chat/src/Http/Controllers/Home/Dashboard/ChatDeleteController.php`

## SQLite 데이터베이스 구조

각 채팅방은 독립된 SQLite 파일로 관리되며, 다음과 같은 테이블 구조를 가집니다:

### 파일 경로
```
database/chat/년도/월/일/room-{id}.sqlite
```

### 테이블 구조

#### 1. `chat_messages` - 채팅 메시지
```sql
CREATE TABLE chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    room_id INTEGER NOT NULL,
    user_uuid VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    message_type VARCHAR(50) DEFAULT 'text',
    reply_to_id INTEGER NULL,
    is_system BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. `chat_message_read` - 메시지 읽음 상태
```sql
CREATE TABLE chat_message_read (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER NOT NULL,
    user_uuid VARCHAR(255) NOT NULL,
    read_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(message_id, user_uuid)
);
```

#### 3. `chat_files` - 첨부파일
```sql
CREATE TABLE chat_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    file_type VARCHAR(100) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4. `chat_message_favourites` - 즐겨찾기
```sql
CREATE TABLE chat_message_favourites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER NOT NULL,
    user_uuid VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(message_id, user_uuid)
);
```

#### 5. `chat_message_translations` - 메시지 번역
```sql
CREATE TABLE chat_message_translations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER NOT NULL,
    user_uuid VARCHAR(255) NOT NULL,
    original_language VARCHAR(10) NOT NULL,
    target_language VARCHAR(10) NOT NULL,
    translated_text TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(message_id, user_uuid, target_language)
);
```

### 인덱스
- `idx_chat_messages_room_id`: 채팅방별 메시지 조회 최적화
- `idx_chat_messages_user_uuid`: 사용자별 메시지 조회 최적화
- `idx_chat_messages_created_at`: 시간순 정렬 최적화
- `idx_chat_message_read_message_id`: 읽음 상태 조회 최적화
- `idx_chat_message_read_user_uuid`: 사용자별 읽음 상태 최적화

## 라우팅 구조

```php
// 채팅방 대시보드
Route::get('/home/chat', ChatIndexController::class)->name('home.chat.index');

// 채팅방 생성
Route::get('/home/chat/rooms/create', 'ChatCreateController@create')->name('home.chat.rooms.create');
Route::post('/home/chat/rooms', ChatCreateController::class)->name('home.chat.rooms.store');

// 채팅방 수정
Route::get('/home/chat/room/{id}/edit', 'ChatEditController@edit')->name('home.chat.rooms.edit');
Route::put('/home/chat/room/{id}', 'ChatEditController@update')->name('home.chat.rooms.update');

// 채팅방 삭제
Route::delete('/home/chat/room/{id}', ChatDeleteController::class)->name('home.chat.rooms.destroy');
```

## 보안 및 권한

### 접근 제어
- 채팅방 수정/삭제는 방장(`owner_uuid`) 권한 필수
- JWT 토큰 기반 사용자 인증
- 각 요청에 대한 권한 검증 수행

### 데이터 보호
- 트랜잭션을 통한 데이터 일관성 보장
- 민감한 작업에 대한 상세 로그 기록
- 파일 업로드 시 보안 검증 (이미지 형식, 크기 제한)

### 에러 처리
- 예외 상황에 대한 적절한 롤백 처리
- 사용자 친화적인 에러 메시지 제공
- 시스템 로그를 통한 디버깅 지원

## 성능 최적화

### 데이터베이스 분산
- 채팅방별 독립 SQLite 파일로 부하 분산
- 년/월/일 디렉토리 구조로 파일 관리 최적화

### 페이지네이션
- 채팅방 목록에 페이지네이션 적용
- 대용량 데이터 처리 시 메모리 사용량 최적화

### 인덱스 활용
- SQLite 테이블에 적절한 인덱스 설정
- 자주 사용되는 쿼리 패턴에 최적화된 인덱스 구성
